<!DOCTYPE html>
<html>
<head>
  <style>
    :root {
      --primary-color: #0D99FF;
      --secondary-color: #007BE5;
      --background-color: #FFFFFF;
      --text-color: #333333;
      --text-secondary: #666666;
      --border-color: #E5E5E5;
      --light-bg: #F5F7FA;
      --success-color: #00C875;
      --error-color: #FF4D4F;
      --warning-color: #FAAD14;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
      --radius-sm: 4px;
      --radius-md: 6px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: var(--background-color);
      color: var(--text-color);
      font-size: 13px;
      line-height: 1.5;
    }

    .header {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
      background: var(--light-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .title-container {
      display: flex;
      align-items: center;
    }
    
    .logo {
      width: 28px;
      height: 28px;
      background-color: var(--primary-color);
      border-radius: 50%;
      margin-right: var(--spacing-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }
    
    .title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .model-info {
      font-size: 11px;
      color: var(--text-secondary);
      background-color: rgba(0, 0, 0, 0.05);
      padding: 3px 6px;
      border-radius: 10px;
    }
    
    .container {
      padding: var(--spacing-md);
    }
    
    .progress-tracker {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--light-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-sm);
      position: relative;
    }
    
    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #DFE1E6;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      margin-right: var(--spacing-sm);
      flex-shrink: 0;
    }
    
    .step-content {
      flex-grow: 1;
    }
    
    .step-title {
      font-weight: 500;
      color: var(--text-secondary);
      margin: 0;
    }
    
    .active-step .step-number {
      background: var(--primary-color);
      color: white;
    }
    
    .active-step .step-title {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .completed-step .step-number {
      background: var(--success-color);
      color: white;
    }
    
    .step-connector {
      position: absolute;
      left: 12px;
      top: 24px;
      height: 24px;
      width: 2px;
      background-color: #DFE1E6;
      z-index: 0;
    }
    
    .progress-step:last-child .step-connector {
      display: none;
    }
    
    .status-card {
      background: var(--light-bg);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border-left: 3px solid var(--primary-color);
    }
    
    .status-icon {
      font-size: 18px;
      margin-right: var(--spacing-md);
      color: var(--primary-color);
    }
    
    .status-content {
      flex-grow: 1;
    }
    
    .status-title {
      font-weight: 600;
      margin: 0 0 var(--spacing-xs) 0;
    }
    
    .status-message {
      color: var(--text-secondary);
      margin: 0;
      font-size: 12px;
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }
    
    .form-label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }
    
    .select-container {
      position: relative;
    }
    
    select {
      width: 100%;
      padding: 10px 12px;
      font-size: 13px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background-color: var(--background-color);
      appearance: none;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(13, 153, 255, 0.1);
    }
    
    .select-arrow {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--text-secondary);
    }
    
    .language-option {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .language-flag {
      width: 16px;
      height: 16px;
      border-radius: 2px;
    }
    
    .advanced-options {
      margin-bottom: var(--spacing-md);
      background: var(--light-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    
    .advanced-header {
      padding: var(--spacing-sm) var(--spacing-md);
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
    }
    
    .advanced-title {
      font-weight: 500;
      margin: 0;
      font-size: 13px;
    }
    
    .advanced-content {
      padding: var(--spacing-md);
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .advanced-content.open {
      max-height: 300px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }
    
    .checkbox-item input[type="checkbox"] {
      margin-right: var(--spacing-sm);
      appearance: none;
      width: 16px;
      height: 16px;
      border: 1px solid var(--border-color);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }
    
    .checkbox-item input[type="checkbox"]:checked {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .checkbox-item input[type="checkbox"]:checked::after {
      content: "";
      position: absolute;
      left: 5px;
      top: 2px;
      width: 3px;
      height: 8px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }
    
    .checkbox-item label {
      cursor: pointer;
      font-size: 12px;
    }
    
    .action-button {
      display: block;
      width: 100%;
      padding: 10px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
      box-shadow: var(--shadow-sm);
    }
    
    .action-button:hover:not(:disabled) {
      background-color: var(--secondary-color);
    }
    
    .action-button:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: none;
    }
    
    .action-button:disabled {
      background-color: var(--border-color);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .debug-area {
      margin-top: var(--spacing-md);
      border-top: 1px solid var(--border-color);
      padding-top: var(--spacing-md);
    }
    
    .debug-toggle {
      margin-bottom: var(--spacing-sm);
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
    }
    
    .debug-content {
      font-family: monospace;
      font-size: 11px;
      background: #F0F2F5;
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm);
      max-height: 120px;
      overflow-y: auto;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    /* Status indicators */
    .status-success {
      border-left-color: var(--success-color);
    }
    
    .status-success .status-icon {
      color: var(--success-color);
    }
    
    .status-error {
      border-left-color: var(--error-color);
    }
    
    .status-error .status-icon {
      color: var(--error-color);
    }
    
    .status-warning {
      border-left-color: var(--warning-color);
    }
    
    .status-warning .status-icon {
      color: var(--warning-color);
    }
    
    /* Progress bar */
    .progress-container {
      margin: var(--spacing-md) 0;
      display: none;
    }
    
    .progress-bar {
      height: 6px;
      background-color: var(--border-color);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }
    
    /* Styles for our new UI elements */
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .checkbox-label input {
      margin-right: 8px;
    }
    
    .help-text {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .secondary-button {
      background-color: var(--light-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .secondary-button:hover {
      background-color: #EAECEF;
    }
    
    .secondary-button:active {
      background-color: #DFE1E6;
    }
    
    .compact-select {
      width: auto;
      margin-left: 8px;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title-container">
      <div class="logo">i18n</div>
      <h1 class="title">Figma I18n Preview</h1>
    </div>
    <div class="model-info">Powered by Claude AI</div>
  </div>
  
  <div class="container">
    <div class="progress-tracker">
      <div id="step1" class="progress-step active-step">
        <div class="step-number">1</div>
        <div class="step-content">
          <h3 class="step-title">Select a frame in your design</h3>
        </div>
        <div class="step-connector"></div>
      </div>
      
      <div id="step2" class="progress-step">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3 class="step-title">Choose target language</h3>
        </div>
        <div class="step-connector"></div>
      </div>
      
      <div id="step3" class="progress-step">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3 class="step-title">Run translation test</h3>
        </div>
      </div>
    </div>
    
    <div id="cacheIndicator" class="status-card status-success" style="display: none;">
      <div class="status-icon">üíæ</div>
      <div class="status-content">
        <h4 class="status-title">Cache Active</h4>
        <p id="cacheStats" class="status-message">Using cached translations when available</p>
      </div>
    </div>

    <div id="statusCard" class="status-card">
      <div class="status-icon">üì¶</div>
      <div class="status-content">
        <h4 class="status-title">Ready to translate</h4>
        <p id="statusMessage" class="status-message">Select a frame to begin translation</p>
      </div>
    </div>
    
    <div id="progressContainer" class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div class="progress-info">
        <span id="progressText">0%</span>
        <span id="translationCount">0/0 elements</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="form-label" for="languageSelect">Target Language</label>
      <div class="select-container">
        <select id="languageSelect">
          <option value="es">üá™üá∏ Spanish (Espa√±ol)</option>
          <option value="fr">üá´üá∑ French (Fran√ßais)</option>
          <option value="de">üá©üá™ German (Deutsch)</option>
          <option value="it">üáÆüáπ Italian (Italiano)</option>
          <option value="pt">üáµüáπ Portuguese (Portugu√™s)</option>
          <option value="hi">üáÆüá≥ Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
          <option value="ja">üáØüáµ Japanese (Êó•Êú¨Ë™û)</option>
          <option value="ko">üá∞üá∑ Korean (ÌïúÍµ≠Ïñ¥)</option>
          <option value="zh">üá®üá≥ Chinese (‰∏≠Êñá)</option>
          <option value="ar">üá¶üá™ Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
          <option value="ru">üá∑üá∫ Russian (–†—É—Å—Å–∫–∏–π)</option>
        </select>
        <div class="select-arrow">‚ñº</div>
      </div>
    </div>

    <div class="advanced-options">
      <div id="advancedHeader" class="advanced-header">
        <h3 class="advanced-title">Advanced Options</h3>
        <span id="advancedToggle">+</span>
      </div>
      <div id="advancedContent" class="advanced-content">
        <div class="checkbox-item">
          <input type="checkbox" id="skipUiElements" checked>
          <label for="skipUiElements">Skip UI elements (buttons, menus, icons)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="skipURLsEmails" checked>
          <label for="skipURLsEmails">Skip URLs and email addresses</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="skipDates" checked>
          <label for="skipDates">Skip dates and timestamps</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="skipPlaceholders" checked>
          <label for="skipPlaceholders">Skip placeholder text</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="skipInstances" checked>
          <label for="skipInstances">Skip text in component instances</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="useCache" checked>
          <label for="useCache">Use translation cache (saves API credits)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="forceRetranslate">
          <label for="forceRetranslate">Force retranslate (ignore cache)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="preserve-styles" checked>
          <label for="preserve-styles">Preserve text styles & formatting</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="use-claude-styling" checked>
          <label for="use-claude-styling">Use AI for improved style matching</label>
        </div>
        <div id="cacheClearContainer" style="margin-top: 12px; display: none;">
          <button id="clearCacheBtn" class="secondary-button">
            Clear Translation Cache
          </button>
          <select id="cacheLangSelect" class="compact-select">
            <option value="">All languages</option>
            <!-- Will be populated with used languages -->
          </select>
        </div>
      </div>
    </div>
    
    <button id="translateButton" class="action-button" disabled>
      Run Translation Test
    </button>
    
    <div class="debug-area">
      <label class="debug-toggle">
        <input type="checkbox" id="showDebug" onChange="toggleDebug()">
        <span>Show debug information</span>
      </label>
      <div id="debugOutput" class="debug-content" style="display: none;">
        Debug information will appear here
      </div>
    </div>
  </div>

  <script>
    let frameSelected = false;
    let debugLog = [];
    let totalElements = 0;
    let processedElements = 0;
    let serverPort = 3000; // Default port
    
    // Try to detect server port
    function detectServerPort() {
      // Try ports 3000-3005
      const tryPort = (port) => {
        fetch(`http://localhost:${port}/health`)
          .then(response => {
            if (response.ok) {
              console.log(`Server detected on port ${port}`);
              serverPort = port;
              addDebugMessage(`Server found on port ${port}`);
              checkCacheStatus(); // Refresh cache with correct port
            }
          })
          .catch(() => {
            console.log(`No server on port ${port}`);
            // Try next port if this one failed
            if (port < 3005) {
              tryPort(port + 1);
            }
          });
      };
      
      // Start checking from port 3000
      tryPort(3000);
    }

    // Initialize advanced options toggle
    document.addEventListener('DOMContentLoaded', function() {
      const advancedHeader = document.getElementById('advancedHeader');
      const advancedContent = document.getElementById('advancedContent');
      const advancedToggle = document.getElementById('advancedToggle');
      
      advancedHeader.addEventListener('click', function() {
        advancedContent.classList.toggle('open');
        advancedToggle.textContent = advancedContent.classList.contains('open') ? '‚àí' : '+';
      });
      
      // Detect server port on load
      detectServerPort();
    });
    
    function toggleDebug() {
      const debugOutput = document.getElementById('debugOutput');
      const showDebug = document.getElementById('showDebug').checked;
      debugOutput.style.display = showDebug ? 'block' : 'none';
    }
    
    function addDebugMessage(message, data) {
      const timestamp = new Date().toLocaleTimeString();
      let logMessage = `${timestamp}: ${message}`;
      if (data) {
        logMessage += ' ' + JSON.stringify(data);
      }
      debugLog.unshift(logMessage);
      if (debugLog.length > 20) debugLog.pop();
      
      const debugOutput = document.getElementById('debugOutput');
      debugOutput.innerHTML = debugLog.join('<br>');
    }
    
    // Add this function to display information messages
    function showInfo(message) {
      console.log('Info:', message);
      const cacheIndicator = document.getElementById('cacheIndicator');
      if (cacheIndicator) {
        cacheIndicator.textContent = message;
        cacheIndicator.style.display = 'block';

        // Show cache clear container if we have cache entries
        if (message.includes('entries') && !message.includes('No cached')) {
          document.getElementById('cacheClearContainer').style.display = 'block';
        }
      }
    }
    
    // Add this function to populate the cache language dropdown
    function populateCacheLanguages(languages) {
      const select = document.getElementById('cacheLangSelect');
      
      // Keep the "All languages" option
      select.innerHTML = '<option value="">All languages</option>';
      
      // Add each language
      Object.keys(languages).forEach(lang => {
        const count = languages[lang];
        const option = document.createElement('option');
        option.value = lang;
        option.textContent = `${lang} (${count} entries)`;
        select.appendChild(option);
      });
    }

    // Update the checkCacheStatus function to use this
    function checkCacheStatus() {
      // Add indicator that we're checking cache
      const cacheIndicator = document.getElementById('cacheIndicator');
      if (cacheIndicator) {
        cacheIndicator.textContent = "Checking cache status...";
        cacheIndicator.style.display = 'block';
      }
      
      fetch(`http://localhost:${serverPort}/cache/stats`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server responded with status ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          addDebugMessage('Cache status', data);
          
          // Populate language dropdown
          if (data.byLanguage) {
            populateCacheLanguages(data.byLanguage);
          }
          
          // Update status
          if (data.totalEntries > 0) {
            showInfo(`Translation cache contains ${data.totalEntries} entries`);
            document.getElementById('cacheClearContainer').style.display = 'block';
          } else {
            showInfo("Translation cache is empty");
            document.getElementById('cacheClearContainer').style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error checking cache status:', error);
          addDebugMessage('Cache status error', {error: error.message});
          
          // Make sure we handle display
          if (cacheIndicator) {
            cacheIndicator.textContent = "Server not available. Start the translation server first.";
            cacheIndicator.style.display = 'block';
          }
          
          // Hide the cache clear container when server is down
          document.getElementById('cacheClearContainer').style.display = 'none';
        });
    }
    
    // Check cache status on load
    checkCacheStatus();
    
    // Refresh cache status every 30 seconds
    setInterval(checkCacheStatus, 30000);

    // Update clearCache to update button state
    async function clearCache() {
      try {
        // Update button state
        const clearBtn = document.getElementById('clearCacheBtn');
        clearBtn.disabled = true;
        clearBtn.textContent = 'Clearing...';
        
        const response = await fetch(`http://localhost:${serverPort}/cache`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          const data = await response.json();
          addDebugMessage('Cache cleared', data);
          
          // Update UI
          document.getElementById('cacheIndicator').style.display = 'none';
          document.getElementById('cacheClearContainer').style.display = 'none';
          
          // Show temporary message
          updateStatus(
            'success',
            'Cache Cleared',
            'Translation cache has been cleared',
            'üßπ'
          );
          
          // Reset button state
          clearBtn.disabled = false;
          clearBtn.textContent = 'Clear Translation Cache';
          
          // Reset status after 3 seconds
          setTimeout(() => {
            if (frameSelected) {
              updateStatus(
                'success', 
                'Frame Selected', 
                `Ready to translate: ${document.getElementById('statusMessage').textContent.replace('Translation cache has been cleared', '')}`, 
                '‚úì'
              );
            } else {
              updateStatus(
                'warning',
                'No Frame Selected',
                'Please select a frame in your design',
                '‚ö†Ô∏è'
              );
            }
          }, 3000);
        }
      } catch (error) {
        console.log('Error clearing cache:', error);
        addDebugMessage('Cache clear failed', { error: error.message });
        
        // Reset button state on error
        const clearBtn = document.getElementById('clearCacheBtn');
        clearBtn.disabled = false;
        clearBtn.textContent = 'Clear Translation Cache';
      }
    }

    function updateSteps(currentStep) {
      document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active-step');
        step.classList.remove('completed-step');
      });
      
      for (let i = 1; i < currentStep; i++) {
        document.getElementById(`step${i}`).classList.add('completed-step');
      }
      
      document.getElementById(`step${currentStep}`).classList.add('active-step');
    }
    
    function updateStatus(type, title, message, icon) {
      const statusCard = document.getElementById('statusCard');
      const statusIcon = statusCard.querySelector('.status-icon');
      const statusTitle = statusCard.querySelector('.status-title');
      const statusMessage = document.getElementById('statusMessage');
      
      // Remove all status classes
      statusCard.classList.remove('status-success', 'status-error', 'status-warning');
      
      // Add appropriate class
      if (type) {
        statusCard.classList.add(`status-${type}`);
      }
      
      // Update content
      statusIcon.textContent = icon || 'üì¶';
      statusTitle.textContent = title || 'Status';
      statusMessage.textContent = message || '';
    }
    
    function updateProgress(progress, count, total) {
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const translationCount = document.getElementById('translationCount');
      
      // Show progress bar if not already visible
      progressContainer.style.display = 'block';
      
      // Update the progress bar
      progressFill.style.width = `${progress}%`;
      progressText.textContent = `${progress}%`;
      translationCount.textContent = `${count}/${total} elements`;
    }

    function enableButton() {
      console.log('Enabling button');
      const button = document.getElementById('translateButton');
      button.disabled = false;
      frameSelected = true;
    }

    function disableButton() {
      console.log('Disabling button');
      const button = document.getElementById('translateButton');
      button.disabled = true;
      frameSelected = false;
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      console.log('Received message:', msg);
      addDebugMessage('Received message', msg);
      
      if (msg.type === 'frameSelected') {
        console.log('Frame selected:', msg.name);
        addDebugMessage('Frame selected', {name: msg.name});
        updateStatus(
          'success', 
          'Frame Selected', 
          `Ready to translate: ${msg.name}`, 
          '‚úì'
        );
        enableButton();
        updateSteps(2);
      } else if (msg.type === 'noFrameSelected') {
        console.log('No frame selected');
        addDebugMessage('No frame selected');
        updateStatus(
          'warning',
          'No Frame Selected',
          'Please select a frame in your design',
          '‚ö†Ô∏è'
        );
        disableButton();
        updateSteps(1);
      } else if (msg.type === 'translationProgress') {
        // Update progress information
        processedElements++;
        updateProgress(
          msg.progress, 
          processedElements,
          totalElements
        );
        
        addDebugMessage('Translation progress', {
          progress: msg.progress,
          originalText: msg.originalText,
          translatedText: msg.translatedText
        });
      } else if (msg.type === 'translationStarted') {
        updateStatus(
          null,
          'Translation in Progress',
          'Translating your design, please wait...',
          'üîÑ'
        );
        
        // Reset progress counters
        processedElements = 0;
        updateProgress(0, 0, totalElements);
        addDebugMessage('Translation started');
      } else if (msg.type === 'translationComplete') {
        updateStatus(
          'success',
          'Translation Complete',
          'Your design has been successfully translated',
          '‚úÖ'
        );
        
        // Show 100% progress
        updateProgress(100, totalElements, totalElements);
        addDebugMessage('Translation complete');
        
        // Re-enable button
        document.getElementById('translateButton').disabled = false;
        document.getElementById('translateButton').textContent = 'Run Translation Test';
      } else if (msg.type === 'error') {
        updateStatus(
          'error',
          'Error Occurred',
          msg.message || 'An error occurred during translation',
          '‚ùå'
        );
        addDebugMessage('Error', {message: msg.message});
        
        // Re-enable button
        document.getElementById('translateButton').disabled = false;
        document.getElementById('translateButton').textContent = 'Try Again';
      } else if (msg.type === 'serverStatus') {
        if (msg.status === 'connected') {
          addDebugMessage('Server connected', msg.details);
          updateStatus(
            'success',
            'Server Connected',
            'Translation server is ready',
            'üîå'
          );
        } else {
          addDebugMessage('Server disconnected', {error: msg.error});
          updateStatus(
            'error',
            'Server Disconnected',
            `Unable to connect to translation server: ${msg.error}`,
            '‚ö°'
          );
          document.getElementById('translateButton').disabled = true;
        }
      } else if (msg.type === 'debugInfo') {
        addDebugMessage('Debug info: ' + msg.message);
      } else if (msg.type === 'textNodeCount') {
        // Store total text nodes for progress tracking
        totalElements = msg.count;
        addDebugMessage('Text node count', {count: msg.count});
      } else if (msg.type === 'cacheCleared') {
        // Update both cache buttons
        if (document.getElementById('advClearCacheBtn')) {
          document.getElementById('advClearCacheBtn').disabled = false;
          document.getElementById('advClearCacheBtn').textContent = 'Clear Translation Cache';
        }
        
        if (document.getElementById('clearCacheBtn')) {
          document.getElementById('clearCacheBtn').disabled = false;
          document.getElementById('clearCacheBtn').textContent = 'Clear Translation Cache';
        }
        
        showSuccess(`Translation cache ${msg.language ? 'for ' + msg.language : ''} cleared successfully`);
        checkCacheStatus(); // Refresh cache stats
      }
    };

    document.getElementById('translateButton').onclick = () => {
      if (!frameSelected) return;
      
      const button = document.getElementById('translateButton');
      const select = document.getElementById('languageSelect');
      
      // Get filter settings
      const filterSettings = {
        skipUiElements: document.getElementById('skipUiElements').checked,
        skipURLsEmails: document.getElementById('skipURLsEmails').checked,
        skipDates: document.getElementById('skipDates').checked,
        skipPlaceholders: document.getElementById('skipPlaceholders').checked,
        skipInstances: document.getElementById('skipInstances').checked
      };
      
      // Get advanced settings
      const forceRetranslate = document.getElementById('forceRetranslate').checked;
      
      // Get style preservation settings (new)
      const preserveStyles = (document.getElementById('preserve-styles') && document.getElementById('preserve-styles').checked) || true;
      const useClaudeStyling = (document.getElementById('use-claude-styling') && document.getElementById('use-claude-styling').checked) || true;
      
      // Disable button during translation
      button.disabled = true;
      button.textContent = 'Translating...';
      
      updateSteps(3);
      
      // Show progress bar
      document.getElementById('progressContainer').style.display = 'block';
      
      // Add debug message
      addDebugMessage('Sending translation request', {
        language: select.options[select.selectedIndex].text,
        languageCode: select.value, 
        filterSettings: filterSettings,
        forceRetranslate: forceRetranslate,
        preserveStyles: preserveStyles,
        useClaudeStyling: useClaudeStyling
      });
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'translateFrame',
          language: select.options[select.selectedIndex].text,
          languageCode: select.value,
          filterSettings: filterSettings,
          forceRetranslate: forceRetranslate,
          preserveStyles: preserveStyles,
          useClaudeStyling: useClaudeStyling
        }
      }, '*');
    };

    document.getElementById('languageSelect').onchange = () => {
      if (frameSelected) {
        updateSteps(2);
      }
    };

    // Check if there's an initial frame selection
    parent.postMessage({ 
      pluginMessage: { 
        type: 'checkInitialSelection'
      }
    }, '*');
    
    // Add JavaScript for the clearCache button
    document.getElementById('clearCacheBtn').addEventListener('click', function() {
      clearCache();
    });

    // Update translation function to include forceRetranslate
    function translate() {
      const targetLang = document.getElementById('targetLang').value;
      const forceRetranslate = document.getElementById('forceRetranslate').checked;
      
      // Validation
      if (!targetLang) {
        showError('Please select a target language');
        return;
      }
      
      // Update UI state
      document.getElementById('translateButton').disabled = true;
      document.getElementById('translateButton').textContent = 'Translating...';
      setStatus('translating', 'Translation in progress');
      
      // Send translation request to plugin
      parent.postMessage({
        pluginMessage: {
          type: 'translate',
          targetLang: targetLang,
          forceRetranslate: forceRetranslate
        }
      }, '*');
    }

    // Add success notification function
    function showSuccess(message) {
      // Use the existing updateStatus function
      updateStatus(
        'success',
        'Success',
        message,
        '‚úÖ'
      );
      
      // Reset status after 3 seconds
      setTimeout(() => {
        if (frameSelected) {
          updateStatus(
            'success', 
            'Frame Selected', 
            `Ready to translate`, 
            '‚úì'
          );
        } else {
          updateStatus(
            'warning',
            'No Frame Selected',
            'Please select a frame in your design',
            '‚ö†Ô∏è'
          );
        }
      }, 3000);
    }
  </script>
</body>
</html>